<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scores - {{ game.name }}</title>

    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            overflow-x: hidden;
            color: white;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(103, 58, 183, 0.4);
        }

        .game-title {
            font-size: 24px;
            font-weight: 700;
            color: white;
        }

        .scoreboard {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .team-row {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 4px solid transparent;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                        background 0.3s ease,
                        opacity 0.3s ease;
        }

        .team-row.moving-up {
            animation: moveUp 0.5s ease-out;
        }

        .team-row.moving-down {
            animation: moveDown 0.5s ease-out;
        }

        @keyframes moveUp {
            0% { transform: translateY(20px); background: rgba(76, 175, 80, 0.2); }
            100% { transform: translateY(0); }
        }

        @keyframes moveDown {
            0% { transform: translateY(-20px); background: rgba(244, 67, 54, 0.2); }
            100% { transform: translateY(0); }
        }

        .team-row.place-1 {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.15), rgba(255, 215, 0, 0.05));
            border-left-color: #ffd700;
        }

        .team-row.place-2 {
            background: linear-gradient(90deg, rgba(192, 192, 192, 0.15), rgba(192, 192, 192, 0.05));
            border-left-color: #c0c0c0;
        }

        .team-row.place-3 {
            background: linear-gradient(90deg, rgba(205, 127, 50, 0.15), rgba(205, 127, 50, 0.05));
            border-left-color: #cd7f32;
        }

        .position {
            font-size: 18px;
            font-weight: 800;
            width: 50px;
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .position-change {
            font-size: 12px;
            font-weight: 600;
        }

        .position-change.up {
            color: #4caf50;
        }

        .position-change.down {
            color: #f44336;
        }

        .team-name {
            flex: 1;
            font-size: 16px;
            font-weight: 600;
            padding: 0 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .team-score {
            font-size: 20px;
            font-weight: 800;
            color: #ffd700;
            min-width: 70px;
            text-align: right;
            transition: transform 0.3s ease;
        }

        .team-score.score-changed {
            animation: scorePop 0.4s ease-out;
        }

        @keyframes scorePop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); color: #fff; }
            100% { transform: scale(1); }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 16px;
        }

        .live-dot {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 12px;
            height: 12px;
            background: #4caf50;
            border-radius: 50%;
            animation: pulse-dot 1.5s ease-in-out infinite;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.3); }
        }

        /* Compact mode for many teams */
        .scoreboard.compact .team-row {
            padding: 8px 12px;
        }

        .scoreboard.compact .position {
            font-size: 14px;
            width: 40px;
        }

        .scoreboard.compact .team-name {
            font-size: 14px;
        }

        .scoreboard.compact .team-score {
            font-size: 16px;
            min-width: 60px;
        }
    </style>
</head>
<body>
    <div class="live-dot" title="Live"></div>

    <div class="container">
        <div class="header">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Fat Big Quiz" class="logo">
            <h1 class="game-title">{{ game.name }}</h1>
        </div>

        <div class="scoreboard" id="scoreboard">
            <div class="empty-state">Loading scores...</div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script>
        const gameId = {{ game.id }};
        let previousScores = {}; // Track previous positions and scores
        let isFirstLoad = true;

        function loadScores() {
            fetch(`/api/game/${gameId}/answers`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.teams && data.teams.length > 0) {
                        updateScoreboard(data.teams);
                    } else {
                        document.getElementById('scoreboard').innerHTML =
                            '<div class="empty-state">Waiting for teams...</div>';
                    }
                })
                .catch(error => {
                    console.log('Error loading scores:', error);
                });
        }

        function updateScoreboard(teams) {
            const scoreboard = document.getElementById('scoreboard');

            // Sort by total score descending
            const sorted = teams.sort((a, b) => b.total_score - a.total_score);

            // Add compact class if many teams
            if (sorted.length > 10) {
                scoreboard.classList.add('compact');
            } else {
                scoreboard.classList.remove('compact');
            }

            // Build new positions map
            const newPositions = {};
            sorted.forEach((team, index) => {
                newPositions[team.team_id] = {
                    position: index + 1,
                    score: team.total_score,
                    name: team.team_name
                };
            });

            // Check if we have existing rows to animate
            const existingRows = scoreboard.querySelectorAll('.team-row');

            if (isFirstLoad || existingRows.length === 0) {
                // First load - just render
                renderScoreboard(sorted, newPositions, {});
                isFirstLoad = false;
            } else {
                // Subsequent load - animate changes
                renderScoreboard(sorted, newPositions, previousScores);
            }

            // Store for next comparison
            previousScores = newPositions;
        }

        function renderScoreboard(sorted, newPositions, oldPositions) {
            const scoreboard = document.getElementById('scoreboard');

            const html = sorted.map((team, index) => {
                const position = index + 1;
                const placeClass = position <= 3 ? `place-${position}` : '';

                // Determine position change
                let positionChangeHtml = '';
                let moveClass = '';
                let scoreChangedClass = '';

                const oldData = oldPositions[team.team_id];
                if (oldData) {
                    const positionDiff = oldData.position - position;
                    if (positionDiff > 0) {
                        positionChangeHtml = `<span class="position-change up">▲${positionDiff}</span>`;
                        moveClass = 'moving-up';
                    } else if (positionDiff < 0) {
                        positionChangeHtml = `<span class="position-change down">▼${Math.abs(positionDiff)}</span>`;
                        moveClass = 'moving-down';
                    }

                    if (oldData.score !== team.total_score) {
                        scoreChangedClass = 'score-changed';
                    }
                }

                return `
                    <div class="team-row ${placeClass} ${moveClass}" data-team-id="${team.team_id}">
                        <div class="position">${position}${positionChangeHtml}</div>
                        <div class="team-name">${escapeHtml(team.team_name)}</div>
                        <div class="team-score ${scoreChangedClass}">${team.total_score}</div>
                    </div>
                `;
            }).join('');

            scoreboard.innerHTML = html;

            // Remove animation classes after animation completes
            setTimeout(() => {
                document.querySelectorAll('.moving-up, .moving-down').forEach(el => {
                    el.classList.remove('moving-up', 'moving-down');
                });
                document.querySelectorAll('.score-changed').forEach(el => {
                    el.classList.remove('score-changed');
                });
            }, 600);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Socket.IO for real-time updates
        const socket = io();

        socket.on('connect', function() {
            console.log('[Scores] Socket connected');
            socket.emit('join_admin', { game_id: gameId });
        });

        socket.on('submission_update', function(data) {
            console.log('[Scores] Submission update');
            loadScores();
        });

        socket.on('score_updated', function(data) {
            console.log('[Scores] Score updated');
            loadScores();
        });

        socket.on('team_joined', function(data) {
            console.log('[Scores] Team joined');
            loadScores();
        });

        // Initialize
        loadScores();

        // Refresh every 3 seconds as backup
        setInterval(loadScores, 3000);
    </script>
</body>
</html>
